<script>
        // 您的專屬 GAS URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz_L2NidT117TndleNl1wlutXsyUrHi38AhZWuOoIdCt_y7KNQG5ZF92rOo4H405smb_w/exec"; 
        let currentMode = "進入";
        let html5QrCode;

        // 登入驗證
        async function login() {
            const pwd = document.getElementById('pwdInput').value.trim();
            if (!pwd) return alert("請輸入密碼");
            
            const msg = document.getElementById('loginMsg');
            msg.innerText = "驗證中...";
            msg.style.color = "blue";
            
            try {
                const response = await fetch(`${GAS_URL}?action=checkPassword&pwd=${encodeURIComponent(pwd)}`);
                const data = await response.json();
                
                if (data.auth) {
                    document.getElementById('loginArea').style.display = 'none';
                    document.getElementById('scannerArea').style.display = 'block';
                    startScanner(); 
                } else {
                    msg.innerText = "密碼錯誤或已過期";
                    msg.style.color = "red";
                }
            } catch (e) {
                alert("網路異常，請確認已連網");
                msg.innerText = "";
            }
        }

        // --- 方案 3 加強版 startScanner ---
        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            // 嘗試啟動後鏡頭
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                console.error("相機啟動錯誤：", err);
                
                // 顯示醒目的指引文字在畫面上
                const errorMsg = "【相機啟動失敗】\n\n偵測到瀏覽器封鎖權限。\n請點擊右上角「...」圖示，\n選擇「使用預設瀏覽器」或「Safari/Chrome」開啟此網頁。";
                
                // 置換掉 reader 區域，直接顯示引導圖片或文字
                document.getElementById('reader').innerHTML = `
                    <div style="background: #fffbe6; color: #856404; padding: 20px; border: 1px solid #ffe58f; border-radius: 10px; text-align: left; font-size: 16px;">
                        ${errorMsg.replace(/\n/g, '<br>')}
                    </div>
                `;
                
                alert("LINE 瀏覽器限制了相機權限，請改用系統瀏覽器開啟。");
            });
        }

        function changeMode(mode) {
            currentMode = mode;
            document.getElementById('currentStatusDisp').innerText = "模式：" + mode + "登記";
            document.getElementById('currentStatusDisp').style.color = (mode === '進入' ? '#28a745' : '#dc3545');
        }

        async function onScanSuccess(decodedText) {
            await html5QrCode.stop();
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        uid: decodedText,
                        status: currentMode
                    })
                });
                const result = await response.json();
                alert(`${currentMode} 成功！\n姓名：${result.name}\n編號：${decodedText}`);
            } catch (e) {
                alert("紀錄失敗，請檢查網路連線");
            }
            
            document.getElementById('loading').style.display = 'none';
            startScanner();
        }
    </script>
